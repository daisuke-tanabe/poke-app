# ポケモン図鑑アプリ 要件定義書

## 1. データ要件

### 1.1 基本データ構造

- ポケモンは何匹でも登録できる。
- ポケモンは必ず全国図鑑（pokedex_id=1）に属する。
- ポケモンは必ず1つ以上のタイプ（例：炎、水など）を持つ。
- 各ポケモンは1つ以上のフォーム（通常、色違い、メガシンカ等）を持つ。
- 各フォームは必ず1つ以上のタイプを持つ。
- ポケモン削除時は、以下の関連レコードも自動削除（ON DELETE CASCADE）される。
  - 図鑑エントリ（PokedexEntry）
  - タイプエントリ（TypeEntry）
  - フォーム（PokemonForm）
- 各図鑑エントリには図鑑名（日本語名）、図鑑番号、slugが含まれる。

### 1.2 データ関係・制約

- **外部キー制約**: `pokemons` → `form_entries` → `pokedex_entries` → `type_entries` の依存関係
- **全国図鑑必須制約**: 全てのポケモンは必ず全国図鑑（pokedex_id=1）に所属する
- **複数図鑑所属**: 同一ポケモンが複数の図鑑に所属可能（全国図鑑 + 地方図鑑）
- **タイプエントリ重複**: 同一ポケモン・フォームが複数図鑑に所属する場合、各図鑑でタイプエントリが作成される

### 1.3 命名規則・形式

- **slug命名規則**: 英語名の小文字化、単語区切りはハイフン（-）、特殊文字は除去
- **多言語対応**: 日本語名、英語名、カナ名の3形式を必須とする
  - `name_ja`: 日本語名（例：フシギダネ）
  - `name_en`: 英語名（例：Bulbasaur）
  - `name_kana`: カタカナをローマ字表示（例：Fushigidane）
- **ID採番**: 連番は1から開始、固定IDは10の倍数を使用

### 1.4 データ整合性・検証

- **データ整合性チェック項目**:
  - 全フォームにタイプが割り当てられていること
  - 全ポケモンが全国図鑑に所属していること
  - スプライトパスが正しい形式であること
  - 図鑑番号に重複がないこと
- **自動検証**: データ投入時に上記項目を自動チェックする仕組みを実装

## 2. 機能要件

### 2.1 ポケモン検索

- 以下の4条件でAND検索できる。
  - 図鑑のslug
    - 必須
  - タイプのslug
    - 任意
    - 2つまで複数選択可
  - 名前
    - 任意
    - 日本語・英語・カナのいずれかに部分一致
  - ページ番号
    - 必須
    - 1ページ30件
- 0件の場合は空配列を返す。
- 検索条件はURLクエリパラメータに反映される。
  - クエリパラメータ例：
    - `?pokedex=national&page=1&name=ピカチュウ&type1=&type2=`
    - `?pokedex=kanto&page=2&name=&type1=fire&type2=flying`

## 3. UI/UX要件

### 3.1 検索UI

- 図鑑名・タイプ・名前の4条件で検索可能。
- 図鑑セレクトは地方ごとにグループ化。
- タイプ選択はアイコン形式で2つまで複数選択可能。
- 名前入力欄は「名前」ラベル。
- 検索ボタンでのみ検索実行。
- 1ページ30件でページネーション表示。

### 3.2 検索結果表示

- 各ポケモンカードに以下を表示：
  - 日本語名・英語名
  - 検索対象になった図鑑（pokedex）の番号を表示する
    - 例: カントー図鑑で検索した場合はカントー図鑑番号、ホウエン図鑑ならホウエン図鑑番号
    - 検索条件（pokedexのslug）に該当するpokedexEntriesから番号を取得し表示
    - national図鑑（slug: national）で検索時は全国図鑑番号
    - ※全てのポケモンは必ず全国図鑑・地方図鑑いずれかに所属し、entry_numberが存在する
  - タイプバッジは`public/type-icons/*`から使用する

## 4. データ取得・API要件

### 4.1 スプライト画像要件

- **画像配置**: Supabase Storageを使用して外部リソースとして管理
- **画像パス形式**: `<Supabase Storageのドメイン、実装には含まない>/storage/v1/object/public<スプライトパス>`
- **ファイル名規則**: `<ポケモンの英語名>[optional-フォームの英語名][optional-shiny].png`
  - 例: `bulbasaur.png`, `vulpix-alola.png`, `vulpix-alola-shiny.png`, `venusaur-mega-shiny.png`
- **命名規則**:
  - 英語名・フォーム名はすべて小文字、区切りはハイフン（-）
  - shinyは色違いの場合のみ末尾に`-shiny`を付与
  - 拡張子は必ず`.png`

### 4.2 データ管理・運用要件

- **マスターデータ管理**:
  - 正規版は `prisma/pokemon-masterdata.json` とする
  - 分割ファイルは `prisma/masterdata/` 配下に配置
  - 更新時は正規版を更新後、分割ファイルを再生成する
- **データ更新手順**:
  1. `pokemon-masterdata.json` を編集
  2. 分割スクリプトで `masterdata/` 配下を再生成
  3. データ整合性チェックを実行
  4. シードでデータベースに反映
- **バックアップ・復旧**:
  - 更新前に `pokemon-masterdata.json` のバックアップを取得
  - 問題発生時はバックアップから復旧
- **環境間データ同期**:
  - 開発・本番環境で同一のマスターデータを使用
  - シード実行前にデータベースを初期化

## 5. 非機能要件

### 5.1 対応環境

- 対応ブラウザ：Google Chrome、Edge、Safari / iOS Safari、Android（直前のメジャーバージョン2つ前まで保証）

### 5.2 データ品質要件

- **データ整合性**: 全フォームにタイプが割り当てられ、全ポケモンが全国図鑑に所属していること
- **パフォーマンス**: 検索結果の表示は3秒以内、ページネーションは1秒以内
- **可用性**: データベース接続エラー時は適切なエラーメッセージを表示

## 6. 開発・運用環境

### 6.1 技術スタック

- TypeScript v5 latest、Next.js v15 latest、Node.js v22 latest、PostgreSQL v17 latest、Prisma v6 latestを使用
- データベースはSupabase CLIでローカル起動したPostgreSQLを利用
- データアクセスレイヤーを設け、サーバーコンポーネントからデータベース操作を行う。
- バックエンドはNode.js、データベースはSupabase（PostgreSQL）、ORMはPrismaを利用。
- UIコンポーネントライブラリとして shadcn/ui（shadcn） を導入し、デザイン・UI実装に利用する。

### 6.2 開発・運用フロー

- **開発環境セットアップ**:
  1. Supabase CLIでローカルPostgreSQLを起動
  2. Prismaマイグレーションを実行
  3. マスターデータでシードを実行
  4. アプリケーションを起動
- **データ更新時の作業フロー**:
  1. `pokemon-masterdata.json` を編集
  2. 分割スクリプトで関連ファイルを再生成
  3. データ整合性チェックを実行
  4. シードでデータベースに反映
  5. アプリケーションで動作確認
